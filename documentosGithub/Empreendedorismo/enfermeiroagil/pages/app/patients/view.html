<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizar Paciente - Enfermeiro Ágil</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- CSS Custom -->
    <link rel="stylesheet" href="../../../../css/main.css">
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../../../../../public/favicon.ico">
</head>
<body>
    
    <!-- Global Loading -->
    <div id="global-loader" class="position-fixed top-0 start-0 w-100 h-100 bg-white d-flex align-items-center justify-content-center" style="z-index: 9999; display: none;">
        <div class="text-center">
            <div class="loading-spinner mb-3"></div>
            <p class="text-muted">Carregando...</p>
        </div>
    </div>

    <!-- Header -->
    <div data-include="../../../../components/header.html"></div>

    <!-- Main Content -->
    <div class="container-fluid" style="margin-top: 80px;">
        <!-- Header do Paciente -->
        <div class="patient-header">
            <div class="container-custom">
                <!-- ... header do paciente (já estava completo) ... -->
            </div>
        </div>

        <div class="container-custom">
            <!-- ... restante do view.html (já estava completo) ... -->
        </div>
    </div>

    <!-- Footer -->
    <div data-include="../../../../components/footer.html"></div>

    <!-- Botões Flutuantes (Mobile) -->
    <div class="action-buttons d-md-none">
        <button class="floating-btn btn-back" onclick="window.history.back()">
            <i class="bi bi-arrow-left"></i>
        </button>
        <button class="floating-btn btn-add-note" onclick="showAddNoteModal()">
            <i class="bi bi-plus"></i>
        </button>
        <button class="floating-btn btn-edit" onclick="editPatient()">
            <i class="bi bi-pencil"></i>
        </button>
    </div>

    <!-- ... modais (já estavam completos) ... -->

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Módulos do App -->
    <script type="module">
        import authService from '../../../../js/modules/auth.js';
        import patientService from '../../../../js/modules/patients.js';
        import { UTILS } from '../../../../js/config/constants.js';
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', async function() {
            await initPatientView();
        });
        
        async function initPatientView() {
            try {
                // Verificar autenticação
                if (!authService.isAuthenticated()) {
                    window.location.href = '../../../auth/login.html';
                    return;
                }
                
                // Obter ID do paciente da URL
                const urlParams = new URLSearchParams(window.location.search);
                currentPatientId = urlParams.get('id');
                
                if (!currentPatientId) {
                    window.location.href = 'index.html';
                    return;
                }
                
                // Carregar dados do usuário
                await loadUserData();
                
                // Carregar paciente
                await loadPatient();
                
                // Carregar evoluções
                await loadNotes();
                
                // Configurar eventos
                setupEventListeners();
                
            } catch (error) {
                console.error('Erro ao inicializar visualização do paciente:', error);
                showError('Erro ao carregar dados do paciente. Tente novamente.');
            }
        }
        
        async function loadUserData() {
            const user = authService.getUser();
            const profile = authService.getUserProfile();
            
            // Atualizar UI
            document.querySelectorAll('.user-name').forEach(el => {
                el.textContent = profile?.full_name || user?.email?.split('@')[0] || 'Usuário';
            });
        }
        
        async function loadPatient() {
            try {
                authService.showLoading();
                
                const result = await patientService.getPatient(currentPatientId);
                
                if (result.success) {
                    currentPatient = result.data;
                    renderPatientInfo();
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                console.error('Erro ao carregar paciente:', error);
                showError('Erro ao carregar paciente: ' + error.message);
                // Redirecionar após 3 segundos
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
            } finally {
                authService.hideLoading();
            }
        }
        
        function renderPatientInfo() {
            if (!currentPatient) return;
            
            // Informações básicas
            document.getElementById('patient-name').textContent = currentPatient.name;
            document.getElementById('info-name').textContent = currentPatient.name;
            
            // Leito
            const bedInfo = currentPatient.bed_number ? 
                `Leito ${currentPatient.bed_number}${currentPatient.room ? ` - ${currentPatient.room}` : ''}` : 
                'Não informado';
            document.getElementById('patient-bed').textContent = bedInfo;
            document.getElementById('info-bed').textContent = bedInfo;
            
            // Idade e sexo
            document.getElementById('info-age').textContent = currentPatient.age ? 
                `${currentPatient.age} anos` : 'Não informada';
            
            const genderText = currentPatient.gender === 'M' ? 'Masculino' : 
                              currentPatient.gender === 'F' ? 'Feminino' : 
                              currentPatient.gender === 'O' ? 'Outro' : 'Não informado';
            document.getElementById('info-gender').textContent = genderText;
            
            // Prioridade
            const priorityText = UTILS.getPriorityText(currentPatient.priority);
            const priorityColor = UTILS.getPriorityColor(currentPatient.priority);
            
            document.getElementById('patient-priority').textContent = priorityText;
            document.getElementById('patient-priority').style.background = priorityColor;
            
            const priorityBadge = document.getElementById('info-priority-badge');
            priorityBadge.textContent = priorityText;
            priorityBadge.style.background = priorityColor;
            priorityBadge.style.color = 'white';
            
            // Datas
            document.getElementById('info-created').textContent = UTILS.formatDate(currentPatient.created_at);
            document.getElementById('info-updated').textContent = UTILS.formatDate(currentPatient.updated_at);
            
            // Diagnóstico
            document.getElementById('info-diagnosis').textContent = currentPatient.main_diagnosis || 
                '<span class="text-muted">Não informado</span>';
            
            // Alergias
            const allergiesElement = document.getElementById('info-allergies');
            if (currentPatient.allergies && currentPatient.allergies.length > 0) {
                allergiesElement.innerHTML = currentPatient.allergies
                    .map(allergy => `<span class="badge bg-danger me-1">${allergy}</span>`)
                    .join('');
            } else {
                allergiesElement.innerHTML = '<span class="text-muted">Nenhuma alergia conhecida</span>';
            }
            
            // Observações
            document.getElementById('info-notes').textContent = currentPatient.notes || 
                '<span class="text-muted">Nenhuma observação</span>';
        }
        
        async function loadNotes() {
            try {
                const result = await patientService.getNursingNotes(currentPatientId);
                
                if (result.success) {
                    notes = result.data;
                    renderNotes();
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                console.error('Erro ao carregar evoluções:', error);
                document.getElementById('notes-timeline').innerHTML = `
                    <div class="alert alert-danger">
                        Erro ao carregar evoluções: ${error.message}
                    </div>
                `;
            }
        }
        
        function renderNotes() {
            const container = document.getElementById('notes-timeline');
            const emptyState = document.getElementById('empty-notes');
            
            if (notes.length === 0) {
                container.classList.add('d-none');
                emptyState.classList.remove('d-none');
                return;
            }
            
            container.classList.remove('d-none');
            emptyState.classList.add('d-none');
            
            // Filtrar notas
            let filteredNotes = notes;
            if (currentNoteFilter !== 'all') {
                filteredNotes = notes.filter(note => note.note_type === currentNoteFilter);
            }
            
            if (filteredNotes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-filter text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">Nenhuma evolução encontrada</h5>
                        <p class="text-muted">Tente ajustar os filtros</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="timeline">';
            
            filteredNotes.forEach(note => {
                const noteTypeClass = `note-${note.note_type}`;
                const noteTypeText = note.note_type === 'evolucao' ? 'Evolução' :
                                   note.note_type === 'medicacao' ? 'Medicação' :
                                   note.note_type === 'procedimento' ? 'Procedimento' : 'Observação';
                
                const formattedTime = UTILS.formatDate(note.created_at);
                const authorName = note.profiles?.full_name || 'Usuário';
                
                html += `
                    <div class="timeline-item">
                        <div class="timeline-content">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <span class="note-type-badge ${noteTypeClass}">${noteTypeText}</span>
                                </div>
                                <div class="text-end">
                                    <div class="timeline-time">${formattedTime}</div>
                                    <div class="timeline-author">${authorName}</div>
                                </div>
                            </div>
                            <div class="note-content">
                                ${note.content.replace(/\n/g, '<br>')}
                            </div>
                            ${note.tags && note.tags.length > 0 ? `
                                <div class="mt-2">
                                    ${note.tags.map(tag => `<span class="badge bg-light text-dark me-1">${tag}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function setupEventListeners() {
            // Logout
            document.querySelectorAll('.logout-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await authService.logout();
                });
            });
            
            // Salvar nota
            document.getElementById('save-note-btn').addEventListener('click', saveNote);
            
            // Compartilhar paciente
            document.getElementById('share-patient-btn').addEventListener('click', sharePatient);
            
            // Templates
            loadNoteTemplates();
        }
        
        function loadNoteTemplates() {
            const templates = patientService.getDefaultTemplates();
            const container = document.getElementById('note-templates');
            
            templates.forEach(template => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn btn-sm btn-outline-secondary';
                button.textContent = template.name;
                button.onclick = () => applyTemplate(template);
                container.appendChild(button);
            });
        }
        
        function applyTemplate(template) {
            document.getElementById('note-type').value = template.category;
            document.getElementById('note-content').value = template.content;
        }
        
        function showAddNoteModal() {
            const modal = new bootstrap.Modal(document.getElementById('addNoteModal'));
            modal.show();
        }
        
        function showShareModal() {
            const modal = new bootstrap.Modal(document.getElementById('shareModal'));
            modal.show();
        }
        
        function showMedicationModal() {
            // Em uma versão completa, isso abriria um modal específico para medicamentos
            document.getElementById('note-type').value = 'medicacao';
            showAddNoteModal();
        }
        
        async function saveNote() {
            try {
                const noteType = document.getElementById('note-type').value;
                const content = document.getElementById('note-content').value;
                const tags = document.getElementById('note-tags').value
                    .split(',')
                    .map(tag => tag.trim())
                    .filter(tag => tag);
                
                // Validação
                if (!noteType || !content) {
                    showError('Preencha todos os campos obrigatórios.');
                    return;
                }
                
                authService.showLoading();
                
                const noteData = {
                    note_type: noteType,
                    content: content,
                    tags: tags
                };
                
                const result = await patientService.createNursingNote(currentPatientId, noteData);
                
                if (result.success) {
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addNoteModal'));
                    modal.hide();
                    
                    // Limpar formulário
                    document.getElementById('add-note-form').reset();
                    
                    // Mostrar mensagem de sucesso
                    showSuccess('Evolução registrada com sucesso!');
                    
                    // Recarregar notas
                    await loadNotes();
                    
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                console.error('Erro ao salvar evolução:', error);
                showError('Erro ao salvar evolução: ' + error.message);
            } finally {
                authService.hideLoading();
            }
        }
        
        async function sharePatient() {
            try {
                const email = document.getElementById('share-email').value;
                const permission = document.getElementById('share-permission').value;
                
                if (!email) {
                    showError('Informe o email do profissional.');
                    return;
                }
                
                authService.showLoading();
                
                // Aqui implementaríamos o compartilhamento real
                // Por enquanto, apenas simulação
                
                setTimeout(() => {
                    authService.hideLoading();
                    
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('shareModal'));
                    modal.hide();
                    
                    // Limpar formulário
                    document.getElementById('share-form').reset();
                    
                    showSuccess('Convite de compartilhamento enviado!');
                }, 1000);
                
            } catch (error) {
                console.error('Erro ao compartilhar paciente:', error);
                showError('Erro ao compartilhar paciente: ' + error.message);
                authService.hideLoading();
            }
        }
        
        function editPatient() {
            window.location.href = `edit.html?id=${currentPatientId}`;
        }
        
        function exportPatientData() {
            if (!currentPatient) return;
            
            const data = {
                paciente: currentPatient,
                evolucoes: notes
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `paciente-${currentPatient.name.replace(/\s+/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('Dados exportados com sucesso!');
        }
        
        // Funções globais
        window.filterNotes = function(filter) {
            currentNoteFilter = filter;
            renderNotes();
        };
        
        function showSuccess(message) {
            const alert = document.getElementById('patient-alert');
            alert.textContent = message;
            alert.className = 'alert-custom alert-custom-success mb-4';
            alert.classList.remove('d-none');
            
            setTimeout(() => {
                alert.classList.add('d-none');
            }, 3000);
        }
        
        function showError(message) {
            const alert = document.getElementById('patient-alert');
            alert.textContent = message;
            alert.className = 'alert-custom alert-custom-danger mb-4';
            alert.classList.remove('d-none');
            
            setTimeout(() => {
                alert.classList.add('d-none');
            }, 5000);
        }
        
    </script>
</body>
</html>