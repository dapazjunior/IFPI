<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurações - Enfermeiro Ágil</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- CSS Custom -->
    <link rel="stylesheet" href="../../../../css/main.css">
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../../../../../public/favicon.ico">
</head>
<body>
    
    <!-- Global Loading -->
    <div id="global-loader" class="position-fixed top-0 start-0 w-100 h-100 bg-white d-flex align-items-center justify-content-center" style="z-index: 9999; display: none;">
        <div class="text-center">
            <div class="loading-spinner mb-3"></div>
            <p class="text-muted">Carregando...</p>
        </div>
    </div>

    <!-- Header -->
    <div data-include="../../../../components/header.html"></div>

    <!-- Sidebar -->
    <div data-include="../../../../components/sidebar.html"></div>

    <!-- Main Content -->
    <div class="container-fluid" style="margin-top: 80px;">
        <div class="settings-container">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="../dashboard.html">Dashboard</a></li>
                    <li class="breadcrumb-item active">Configurações</li>
                </ol>
            </nav>
            
            <!-- ... restante do settings/index.html (já estava completo) ... -->
        </div>
    </div>

    <!-- Footer -->
    <div data-include="../../../../components/footer.html"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Módulos do App -->
    <script type="module">
        import authService from '../../../../js/modules/auth.js';
        import { UTILS } from '../../../../js/config/constants.js';
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', async function() {
            await initSettingsPage();
        });
        
        async function initSettingsPage() {
            try {
                // Verificar autenticação
                if (!authService.isAuthenticated()) {
                    window.location.href = '../../../auth/login.html';
                    return;
                }
                
                // Carregar dados do usuário
                await loadUserData();
                
                // Carregar configurações
                loadSettings();
                
                // Configurar eventos
                setupEventListeners();
                
            } catch (error) {
                console.error('Erro ao inicializar página de configurações:', error);
                showError('Erro ao carregar configurações. Tente novamente.');
            }
        }
        
        async function loadUserData() {
            const user = authService.getUser();
            const profile = authService.getUserProfile();
            
            // Atualizar UI
            document.querySelectorAll('.user-name').forEach(el => {
                el.textContent = profile?.full_name || user?.email?.split('@')[0] || 'Usuário';
            });
            
            // Preencher formulário de perfil
            if (profile) {
                document.getElementById('profile-name').value = profile.full_name || '';
                document.getElementById('profile-email').value = user.email || '';
                document.getElementById('profile-cpf').value = profile.cpf || '';
                document.getElementById('profile-phone').value = profile.phone || '';
                document.getElementById('profile-specialization').value = profile.specialization || '';
                document.getElementById('profile-institution').value = profile.institution || '';
                document.getElementById('profile-register').value = profile.professional_id || '';
                document.getElementById('profile-role').value = profile.role || 'enfermeiro';
            }
        }
        
        function loadSettings() {
            // Carregar preferências do localStorage
            const preferences = JSON.parse(localStorage.getItem('enfermeiro-agil_preferences') || '{}');
            
            // Interface
            document.getElementById('dark-mode').checked = preferences.darkMode || false;
            document.getElementById('compact-view').checked = preferences.compactView !== false;
            document.getElementById('auto-save').checked = preferences.autoSave !== false;
            document.getElementById('language').value = preferences.language || 'pt-BR';
            document.getElementById('timezone').value = preferences.timezone || 'America/Sao_Paulo';
            
            // Documentação
            document.getElementById('default-note-type').value = preferences.defaultNoteType || 'evolucao';
            document.getElementById('date-format').value = preferences.dateFormat || 'dd/MM/yyyy';
            document.getElementById('time-format').value = preferences.timeFormat || '24';
            
            // Notificações
            document.getElementById('email-general').checked = preferences.emailGeneral !== false;
            document.getElementById('email-security').checked = preferences.emailSecurity !== false;
            document.getElementById('email-promo').checked = preferences.emailPromo !== false;
            document.getElementById('app-reminders').checked = preferences.appReminders !== false;
            document.getElementById('app-shared').checked = preferences.appShared !== false;
            document.getElementById('app-updates').checked = preferences.appUpdates !== false;
        }
        
        function setupEventListeners() {
            // Logout
            document.querySelectorAll('.logout-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await authService.logout();
                });
            });
            
            // Formulário de perfil
            document.getElementById('profile-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveProfile();
            });
            
            // Formulário de senha
            document.getElementById('password-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await changePassword();
            });
        }
        
        async function saveProfile() {
            try {
                const profileData = {
                    full_name: document.getElementById('profile-name').value,
                    cpf: document.getElementById('profile-cpf').value,
                    phone: document.getElementById('profile-phone').value,
                    specialization: document.getElementById('profile-specialization').value,
                    institution: document.getElementById('profile-institution').value,
                    professional_id: document.getElementById('profile-register').value
                };
                
                authService.showLoading();
                
                const result = await authService.updateProfile(profileData);
                
                if (result.success) {
                    showSuccess('Perfil atualizado com sucesso!');
                    await loadUserData(); // Recarregar dados
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                console.error('Erro ao salvar perfil:', error);
                showError('Erro ao salvar perfil: ' + error.message);
            } finally {
                authService.hideLoading();
            }
        }
        
        async function changePassword() {
            try {
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                // Validação
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showError('Preencha todos os campos.');
                    return;
                }
                
                if (newPassword.length < 8) {
                    showError('A nova senha deve ter pelo menos 8 caracteres.');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showError('As senhas não coincidem.');
                    return;
                }
                
                authService.showLoading();
                
                // Em uma implementação real, isso chamaria o Supabase
                // Por enquanto, simularemos
                
                setTimeout(() => {
                    authService.hideLoading();
                    document.getElementById('password-form').reset();
                    showSuccess('Senha alterada com sucesso!');
                }, 1000);
                
            } catch (error) {
                console.error('Erro ao alterar senha:', error);
                showError('Erro ao alterar senha: ' + error.message);
                authService.hideLoading();
            }
        }
        
        function savePreferences() {
            const preferences = {
                // Interface
                darkMode: document.getElementById('dark-mode').checked,
                compactView: document.getElementById('compact-view').checked,
                autoSave: document.getElementById('auto-save').checked,
                language: document.getElementById('language').value,
                timezone: document.getElementById('timezone').value,
                
                // Documentação
                defaultNoteType: document.getElementById('default-note-type').value,
                dateFormat: document.getElementById('date-format').value,
                timeFormat: document.getElementById('time-format').value,
                
                // Notificações
                emailGeneral: document.getElementById('email-general').checked,
                emailSecurity: document.getElementById('email-security').checked,
                emailPromo: document.getElementById('email-promo').checked,
                appReminders: document.getElementById('app-reminders').checked,
                appShared: document.getElementById('app-shared').checked,
                appUpdates: document.getElementById('app-updates').checked
            };
            
            localStorage.setItem('enfermeiro-agil_preferences', JSON.stringify(preferences));
            showSuccess('Preferências salvas com sucesso!');
            
            // Aplicar mudanças imediatas
            applyPreferences(preferences);
        }
        
        function saveNotificationPreferences() {
            const preferences = JSON.parse(localStorage.getItem('enfermeiro-agil_preferences') || '{}');
            
            preferences.emailGeneral = document.getElementById('email-general').checked;
            preferences.emailSecurity = document.getElementById('email-security').checked;
            preferences.emailPromo = document.getElementById('email-promo').checked;
            preferences.appReminders = document.getElementById('app-reminders').checked;
            preferences.appShared = document.getElementById('app-shared').checked;
            preferences.appUpdates = document.getElementById('app-updates').checked;
            
            localStorage.setItem('enfermeiro-agil_preferences', JSON.stringify(preferences));
            showSuccess('Preferências de notificação salvas!');
        }
        
        function applyPreferences(preferences) {
            // Aplicar modo escuro se ativado
            if (preferences.darkMode) {
                document.documentElement.setAttribute('data-bs-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-bs-theme');
            }
            
            // Aplicar outras preferências conforme necessário
            console.log('Preferências aplicadas:', preferences);
        }
        
        function exportAllData() {
            if (confirm('Deseja exportar todos os seus dados? Isso pode levar alguns segundos.')) {
                // Em uma implementação real, buscaríamos dados do Supabase
                // Por enquanto, simularemos
                
                const data = {
                    exportedAt: new Date().toISOString(),
                    user: authService.getUser(),
                    profile: authService.getUserProfile(),
                    preferences: JSON.parse(localStorage.getItem('enfermeiro-agil_preferences') || '{}')
                };
                
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `enfermeiro-agil-dados-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showSuccess('Dados exportados com sucesso!');
            }
        }
        
        function deleteAccount() {
            if (confirm('Tem certeza que deseja excluir sua conta permanentemente? TODOS os seus dados serão perdidos e esta ação NÃO pode ser desfeita.')) {
                if (prompt('Digite "EXCLUIR" para confirmar:') === 'EXCLUIR') {
                    // Em uma implementação real, deletaríamos do Supabase
                    // Por enquanto, simularemos
                    
                    authService.showLoading();
                    
                    setTimeout(() => {
                        authService.hideLoading();
                        showSuccess('Conta excluída. Redirecionando...');
                        
                        setTimeout(() => {
                            authService.logout();
                        }, 2000);
                    }, 2000);
                } else {
                    showError('Confirmação incorreta. A conta não foi excluída.');
                }
            }
        }
        
        function upgradePlan() {
            showMessage('Redirecionando para página de upgrade...', 'info');
            // Em uma implementação real, redirecionaríamos para página de checkout
        }
        
        function showSuccess(message) {
            const alert = document.getElementById('settings-alert');
            alert.textContent = message;
            alert.className = 'alert-custom alert-custom-success mb-4';
            alert.classList.remove('d-none');
            
            setTimeout(() => {
                alert.classList.add('d-none');
            }, 3000);
        }
        
        function showError(message) {
            const alert = document.getElementById('settings-alert');
            alert.textContent = message;
            alert.className = 'alert-custom alert-custom-danger mb-4';
            alert.classList.remove('d-none');
            
            setTimeout(() => {
                alert.classList.add('d-none');
            }, 5000);
        }
        
        function showMessage(message, type = 'info') {
            const alert = document.getElementById('settings-alert');
            alert.textContent = message;
            alert.className = `alert-custom alert-custom-${type} mb-4`;
            alert.classList.remove('d-none');
            
            setTimeout(() => {
                alert.classList.add('d-none');
            }, 3000);
        }
        
    </script>
</body>
</html>