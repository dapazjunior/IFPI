<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Enfermeiro Ágil</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- CSS Custom -->
    <link rel="stylesheet" href="../../../css/main.css">
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../../../../public/favicon.ico">
</head>
<body>
    
    <!-- Global Loading -->
    <div id="global-loader" class="position-fixed top-0 start-0 w-100 h-100 bg-white d-flex align-items-center justify-content-center" style="z-index: 9999; display: none;">
        <div class="text-center">
            <div class="loading-spinner mb-3"></div>
            <p class="text-muted">Carregando...</p>
        </div>
    </div>

    <!-- Header -->
    <div data-include="../../../components/header.html"></div>

    <!-- Sidebar -->
    <div data-include="../../../components/sidebar.html"></div>

    <!-- Main Content -->
    <div class="container-fluid" style="margin-top: 80px;">
        <div class="row">
            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Header -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <div>
                        <h1 class="h2">Dashboard</h1>
                        <p class="text-muted mb-0" id="welcome-message">Bem-vindo de volta!</p>
                    </div>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button class="btn btn-custom btn-custom-primary" data-bs-toggle="modal" data-bs-target="#newPatientModal">
                            <i class="bi bi-plus-circle me-2"></i>Novo Paciente
                        </button>
                    </div>
                </div>

                <!-- Alertas -->
                <div id="dashboard-alert" class="alert-custom alert-custom-info mb-4 d-none"></div>

                <!-- ... restante do dashboard HTML (já estava completo) ... -->
            </main>
        </div>
    </div>

    <!-- Footer -->
    <div data-include="../../../components/footer.html"></div>

    <!-- Modal: Novo Paciente -->
    <div class="modal fade" id="newPatientModal" tabindex="-1">
        <!-- ... modal já existente ... -->
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Módulos do App -->
    <script type="module">
        import authService from '../../../js/modules/auth.js';
        import patientService from '../../../js/modules/patients.js';
        import { UTILS } from '../../../js/config/constants.js';
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', async function() {
            await initDashboard();
        });
        
        async function initDashboard() {
            try {
                // Verificar autenticação
                if (!authService.isAuthenticated()) {
                    window.location.href = '../../auth/login.html';
                    return;
                }
                
                // Carregar dados do usuário
                await loadUserData();
                
                // Carregar estatísticas
                await loadStatistics();
                
                // Carregar pacientes recentes
                await loadRecentPatients();
                
                // Configurar eventos
                setupEventListeners();
                
            } catch (error) {
                console.error('Erro ao inicializar dashboard:', error);
                showError('Erro ao carregar dashboard. Tente novamente.');
            }
        }
        
        async function loadUserData() {
            const user = authService.getUser();
            const profile = authService.getUserProfile();
            
            // Atualizar UI
            document.querySelectorAll('.user-name').forEach(el => {
                el.textContent = profile?.full_name || user?.email?.split('@')[0] || 'Usuário';
            });
            
            document.querySelectorAll('.user-role').forEach(el => {
                if (profile?.role) {
                    const roleNames = {
                        'enfermeiro': 'Enfermeiro(a)',
                        'tecnico': 'Técnico(a)',
                        'estudante': 'Estudante',
                        'admin': 'Administrador'
                    };
                    el.textContent = roleNames[profile.role] || profile.role;
                }
            });
            
            // Mensagem de boas-vindas
            const welcomeMessage = document.getElementById('welcome-message');
            const hour = new Date().getHours();
            let greeting = 'Boa noite';
            
            if (hour < 12) greeting = 'Bom dia';
            else if (hour < 18) greeting = 'Boa tarde';
            
            welcomeMessage.textContent = `${greeting}, ${profile?.full_name?.split(' ')[0] || 'profissional'}!`;
        }
        
        async function loadStatistics() {
            try {
                const result = await patientService.getStatistics();
                
                if (result.success) {
                    const stats = result.data;
                    
                    // Atualizar estatísticas
                    document.getElementById('total-patients').textContent = stats.totalPatients;
                    document.getElementById('high-priority').textContent = stats.priorityStats.alta;
                    
                    // Calcular tempo economizado (estimativa: 10min por evolução)
                    const timeSaved = Math.floor(stats.recentNotes * 10 / 60);
                    document.getElementById('time-saved').textContent = `${timeSaved}h`;
                    
                    // Para "Evoluções Hoje", precisaríamos de uma função específica
                    // Por enquanto, usaremos as dos últimos 7 dias
                    document.getElementById('today-notes').textContent = stats.recentNotes;
                    
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }
        
        async function loadRecentPatients() {
            try {
                const result = await patientService.getPatients({}, 1, 5);
                
                if (result.success) {
                    const container = document.getElementById('recent-patients');
                    
                    if (result.data.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-4">
                                <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-2">Nenhum paciente cadastrado ainda</p>
                                <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#newPatientModal">
                                    <i class="bi bi-plus-circle me-2"></i>Cadastrar Primeiro Paciente
                                </button>
                            </div>
                        `;
                        return;
                    }
                    
                    let html = '';
                    result.data.forEach(patient => {
                        const priorityClass = `priority-${patient.priority}`;
                        const formattedDate = UTILS.formatDate(patient.created_at);
                        
                        html += `
                            <div class="patient-card ${priorityClass}" onclick="viewPatient('${patient.id}')">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h6 class="mb-1">${patient.name}</h6>
                                        <div class="d-flex align-items-center">
                                            <span class="priority-badge ${priorityClass} me-2">
                                                ${UTILS.getPriorityText(patient.priority)}
                                            </span>
                                            <small class="text-muted">
                                                <i class="bi bi-hospital me-1"></i>${patient.bed_number || 'Sem leito'}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted">${formattedDate}</small>
                                    </div>
                                </div>
                                ${patient.main_diagnosis ? `
                                    <p class="text-muted small mb-0">
                                        <i class="bi bi-clipboard2-pulse me-1"></i>
                                        ${patient.main_diagnosis}
                                    </p>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                    
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                console.error('Erro ao carregar pacientes:', error);
                document.getElementById('recent-patients').innerHTML = `
                    <div class="alert alert-danger">
                        Erro ao carregar pacientes: ${error.message}
                    </div>
                `;
            }
        }
        
        function setupEventListeners() {
            // Logout
            document.querySelectorAll('.logout-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await authService.logout();
                });
            });
            
            // Salvar paciente
            document.getElementById('save-patient-btn').addEventListener('click', async () => {
                await saveNewPatient();
            });
            
            // Fechar modal ao salvar
            const newPatientModal = document.getElementById('newPatientModal');
            if (newPatientModal) {
                newPatientModal.addEventListener('hidden.bs.modal', function() {
                    document.getElementById('new-patient-form').reset();
                });
            }
        }
        
        async function saveNewPatient() {
            try {
                const patientData = {
                    name: document.getElementById('patient-name').value,
                    bed_number: document.getElementById('patient-bed').value,
                    priority: document.getElementById('patient-priority').value,
                    age: parseInt(document.getElementById('patient-age').value) || null,
                    gender: document.getElementById('patient-gender').value,
                    main_diagnosis: document.getElementById('patient-diagnosis').value,
                    allergies: document.getElementById('patient-allergies').value
                        .split(',')
                        .map(a => a.trim())
                        .filter(a => a),
                    notes: document.getElementById('patient-notes').value
                };
                
                // Validação
                if (!patientData.name.trim()) {
                    showError('O nome do paciente é obrigatório.');
                    return;
                }
                
                // Salvar
                authService.showLoading();
                const result = await patientService.createPatient(patientData);
                authService.hideLoading();
                
                if (result.success) {
                    // Fechar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('newPatientModal'));
                    modal.hide();
                    
                    // Mostrar mensagem de sucesso
                    showSuccess('Paciente cadastrado com sucesso!');
                    
                    // Recarregar lista de pacientes
                    await loadRecentPatients();
                    await loadStatistics();
                    
                } else {
                    showError(result.error);
                }
                
            } catch (error) {
                console.error('Erro ao salvar paciente:', error);
                showError('Erro ao salvar paciente. Tente novamente.');
            }
        }
        
        function viewPatient(patientId) {
            window.location.href = `patients/view.html?id=${patientId}`;
        }
        
        function showSuccess(message) {
            const alert = document.getElementById('dashboard-alert');
            alert.textContent = message;
            alert.className = 'alert-custom alert-custom-success mb-4';
            alert.classList.remove('d-none');
            
            setTimeout(() => {
                alert.classList.add('d-none');
            }, 3000);
        }
        
        function showError(message) {
            const alert = document.getElementById('dashboard-alert');
            alert.textContent = message;
            alert.className = 'alert-custom alert-custom-danger mb-4';
            alert.classList.remove('d-none');
            
            setTimeout(() => {
                alert.classList.add('d-none');
            }, 5000);
        }
        
        // Tornar funções disponíveis globalmente para onclick
        window.viewPatient = viewPatient;
        
    </script>
</body>
</html>